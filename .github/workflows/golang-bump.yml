#
# .github/workflows/golang-bump.yml
#

# https://github.com/crazy-max/ghaction-import-gpg
# https://github.com/juliangruber/approve-pull-request-action
# https://github.com/peter-evans/create-or-update-project-card
# https://github.com/peter-evans/create-pull-request
# https://github.com/peter-evans/enable-pull-request-automerge
---

name: "Golang Version Bump Workflow"

on:  # yamllint disable-line rule:truthy
  schedule:
    #         ┌───────────── minute (0 - 59)
    #         │ ┌───────────── hour (0 - 23)
    #         │ │ ┌───────────── day of the month (1 - 31)
    #         │ │ │ ┌───────────── month (1 - 12 or JAN-DEC)
    #         │ │ │ │ ┌───────────── day of the week (0 - 6 or SUN-SAT)
    #         │ │ │ │ │
    #         │ │ │ │ │
    #         │ │ │ │ │
    #         * * * * *
    - cron: '30 * * * *'

defaults:
  run:
    shell: bash

jobs:
  version-bump:
    name: Golang Version Bump

    runs-on: ubuntu-latest

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
          submodules: recursive

      # Adding this because the image usually has a dead version of Go.
      - name: Set up Go (using version in go.mod)
        id: setup-go
        uses: actions/setup-go@v3
        with:
          go-version-file: './go.mod'

      - name: Install Dependencies
        run: |
          go version

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Bump Golang Version
        run: |
          git config user.name 'Victor Payno (GitHub Action Bot)'
          git config user.email 'vpayno@users.noreply.github.com'
          ./scripts/go-version-bump

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          branch: bump_golang_version
          branch-suffix: timestamp
          delete-branch: true
          labels: |
            bump:minor
            automated pr
          assignees: vpayno
          reviewers: vpayno
          team-reviewers: |
            owners
            maintainers
          title: Bump Golang Version

      - name: Check PR outputs
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          printf "Pull Request Number: %s\n" "${{ steps.cpr.outputs.pull-request-number }}"
          printf "Pull Request URL   : %s\n" "${{ steps.cpr.outputs.pull-request-url }}"

      - name: Create or Update Project Card
        id: coupc
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: peter-evans/create-or-update-project-card@v2
        with:
          project-name: powerful-cli-apps-in-go-workspace
          column-name: In Progress
          issue-number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Check PC output
        if: ${{ steps.coupc.outputs.card-id }}
        run: |
          printf "Project Card ID: %s\n" "${{ steps.coupc.outputs.card-id }}"

      - name: Auto approve
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.PAT }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: rebase
